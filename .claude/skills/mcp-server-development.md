# MCP Server Development

## 概要

Model Context Protocol (MCP) サーバーの開発ガイド。ツール定義、エラーハンドリング、タイムアウト管理、トランスポート層の設計など、MCPプロトコルに準拠したサーバー実装のベストプラクティスを提供する。

## 適用場面

- 新規MCPサーバーの実装
- 既存MCPサーバーへのツール追加
- MCPサーバーのデバッグ・トラブルシューティング
- MCPクライアントとの統合テスト

## ベストプラクティス

### 1. ツール定義

- ツール名はkebab-caseで命名する（例: `get-file-info`）
- `description` は簡潔かつ正確に記述し、AIが適切に選択できるようにする
- `inputSchema` にJSON Schemaで入力パラメータを厳密に定義する
- 必須パラメータと任意パラメータを明確に区別する
- パラメータの `description` にも具体的な説明と例を含める

### 2. エラーハンドリング

- `isError: true` フラグを使い、ツールエラーをプロトコルレベルで通知する
- エラーメッセージは人間が読んで理解できる内容にする
- 内部例外はログに記録し、外部にはサニタイズしたメッセージを返す
- 入力バリデーションエラーと実行時エラーを区別する
- リトライ可能なエラーかどうかをメッセージで示す

### 3. タイムアウトとリソース管理

- 長時間実行タスクにはprogress通知を実装する
- 外部APIコールにはタイムアウトを必ず設定する
- リソースの取得・解放をtry-finallyで保証する
- 同時実行数の制限（セマフォ）を検討する
- キャンセレーションに対応する

### 4. トランスポート設計

- stdio トランスポートをデフォルトとして実装する
- SSE (Server-Sent Events) トランスポートをオプションで提供する
- JSONRPCメッセージの送受信をログに記録する（デバッグ用）
- 接続のライフサイクル管理（初期化・切断）を適切に実装する

### 5. テスト戦略

- ツールごとにユニットテストを作成する
- MCPクライアントを用いた統合テストを実装する
- エッジケース（無効な入力、タイムアウト、大量データ）をテストする
- CIパイプラインにMCPサーバーの起動テストを含める

## チェックリスト

- [ ] 全ツールにinputSchemaが定義されている
- [ ] エラー時にisError: trueを返している
- [ ] タイムアウトが全ての外部呼び出しに設定されている
- [ ] ツールのdescriptionがAIにとって十分明確である
- [ ] stdioトランスポートが正しく動作する
- [ ] ログ出力がstderrに向いている（stdoutはJSONRPC用）
- [ ] package.jsonのbinフィールドが正しく設定されている

## 関連スキル

- [TypeScript開発](./typescript-development.md)
- [テスト駆動開発](./tdd-workflow.md)
- [セキュリティ監査](./security-audit.md)
