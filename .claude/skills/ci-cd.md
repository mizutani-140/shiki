# CI/CD

## 概要

CI/CD (Continuous Integration / Continuous Delivery) パイプラインの設計と運用ガイド。テストステージ、デプロイメントゲート、ロールバック戦略を含む、信頼性の高いリリースプロセスを構築する。

## 適用場面

- CI/CDパイプラインの新規構築
- 既存パイプラインの改善・高速化
- デプロイメント戦略の設計
- リリースプロセスの自動化

## ベストプラクティス

### 1. パイプライン設計

- パイプラインは「高速フィードバック」を最優先に設計する
- 失敗が早い段階で検出されるようにステージを順序付ける
- lint -> unit test -> build -> integration test -> deploy の順序を基本とする
- 各ステージの実行時間を計測し、ボトルネックを改善する
- パイプライン全体の実行時間は10分以内を目標とする

### 2. テストステージ

- ユニットテストは全PRで必須実行する
- 統合テストはマージ前に実行する
- E2Eテストはデプロイ前に実行する
- テストの並列実行でフィードバック時間を短縮する
- Flaky test（不安定なテスト）は即座に修正または隔離する

### 3. デプロイメントゲート

- mainブランチは常にデプロイ可能な状態を維持する
- 環境ごとにデプロイゲートを設定する（staging -> production）
- 手動承認ゲートをproductionデプロイ前に設定する
- feature flagでデプロイとリリースを分離する
- カナリアデプロイで段階的にトラフィックを移行する

### 4. ロールバック戦略

- ロールバック手順を事前に文書化・テストする
- 自動ロールバックのトリガー条件を定義する（エラー率、レイテンシ等）
- データベースマイグレーションは後方互換性を保つ
- ロールバック実行時間は5分以内を目標とする
- ロールバック後のポストモーテムを必ず実施する

### 5. GitHub Actions の活用

- ワークフローファイルをモジュール化する（reusable workflows）
- キャッシュ (`actions/cache`) を活用してビルド時間を短縮する
- matrixビルドで複数環境を並列テストする
- 環境シークレットはGitHub Secretsで管理する
- セルフホストランナーのセキュリティに注意する

## チェックリスト

- [ ] 全PRでCIが自動実行される
- [ ] テストが並列実行されている
- [ ] パイプライン実行時間が10分以内である
- [ ] デプロイゲートが環境ごとに設定されている
- [ ] ロールバック手順が文書化・テスト済みである
- [ ] シークレットがGitHub Secretsで管理されている
- [ ] Flaky testが存在しない

## 関連スキル

- [テスト駆動開発](./tdd-workflow.md)
- [Gitワークフロー](./git-workflow.md)
- [セキュリティ監査](./security-audit.md)
