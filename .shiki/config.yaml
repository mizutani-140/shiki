version: 2
name: shiki

# --- Mode Detection ---
# auto: detect from environment (GITHUB_ACTIONS=true → github, else → cli)
# cli:  force CLI mode (Agent Teams native)
# github: force GitHub mode (Issue/Label/Worktree driven)
mode: auto

communication:
  primary: mcp
  fallback: file-bridge

# --- CLI Mode Settings ---
cli:
  display: tmux          # tmux | iterm2 | in-process
  delegate_mode: true    # Leader uses Delegate Mode (no Edit/Write)
  self_claim: true       # Members can self-claim unassigned tasks
  plan_mode_required: true  # Members start in Plan Mode

# --- GitHub Mode Settings ---
# 認証方式:
#   oauth: Claude Max/Pro プランの OAuth トークン（推奨・サブスク枠内）
#   api_key: Anthropic API キー（従量課金）
# GitHub Secrets に CLAUDE_CODE_OAUTH_TOKEN または ANTHROPIC_API_KEY を設定
# 両方設定した場合、OAuth が優先される
github:
  enabled: true
  auth_method: oauth   # oauth | api_key（ドキュメント用。実際の切替は GitHub Secrets で行う）
  worktree:
    enabled: true
    base_dir: ../worktrees
    cleanup_on_merge: true
  dag:
    max_parallel_batch: 4
    timeout_minutes: 30
  budget:
    max_tokens_per_task: 100000
    max_tokens_per_session: 500000
    warn_threshold_pct: 80

# --- Convergence Model (theta phases) ---
convergence:
  theta_1_understand:
    description: "Goal comprehension and scope definition"
    exit_criteria: ["acceptance_criteria_defined", "scope_bounded"]
  theta_2_generate:
    description: "Plan generation and task decomposition"
    exit_criteria: ["plan_created", "tasks_decomposed", "contracts_drafted"]
  theta_3_allocate:
    description: "Resource allocation and DAG construction"
    exit_criteria: ["dag_valid", "roles_assigned", "dependencies_resolved"]
  theta_4_execute:
    description: "Implementation and testing"
    exit_criteria: ["all_tasks_completed", "acceptance_passed"]
  theta_5_verify:
    description: "Review, security, and quality verification"
    exit_criteria: ["review_approved", "security_passed", "contracts_verified"]
  theta_6_integrate:
    description: "Integration, merge, and release"
    exit_criteria: ["ci_passed", "merged", "deployed_or_tagged"]

# --- Dual Engine Architecture ---
# Claude Agent Teams: 判断・協調（計画/レビュー/リファクタリング/デバッグ）
# Codex:              隔離実行（実装/テスト生成/CI修復/定型コード）
engines:
  claude:
    enabled: true
    auth: oauth                    # oauth | api_key
    # GitHub Secrets: CLAUDE_CODE_OAUTH_TOKEN (oauth) or ANTHROPIC_API_KEY (api_key)
    strengths:
      - planning                   # θ₁-θ₃
      - review                     # θ₅
      - architecture
      - debugging
      - multi-file-refactor
      - security-fix
    max_turns: 8

  codex:
    enabled: true
    # 認証方式:
    #   login: Pro/Plus プランの codex login（推奨・サブスク枠内、CLI のみ）
    #   api_key: OPENAI_API_KEY（従量課金、CLI + GitHub Actions 両対応）
    # CLI モード: login を推奨（codex login でブラウザ認証、~/.codex/ にトークン保存）
    # GitHub Actions: api_key のみ対応（CI はブラウザ認証不可のため）
    auth: login                    # login | api_key
    sandbox: workspace-write       # workspace-write | read-only | danger-full-access
    strengths:
      - implementation             # 単一ファイル実装
      - test-writing
      - ci-fix
      - boilerplate
      - docs-generation
      - single-file-bugfix
    max_turns: 10

  routing:
    strategy: affinity             # affinity (タスク特性) | round-robin | claude-only | codex-only
    fallback: true                 # primary 失敗時に secondary で再試行
    fallback_max_retries: 1        # フォールバック再試行回数
    # θフェーズ別デフォルトエンジン
    phase_defaults:
      understand: claude           # θ₁
      generate: claude             # θ₂
      allocate: claude             # θ₃
      execute: auto                # θ₄ → router が判断
      verify: claude               # θ₅
      integrate: claude            # θ₆

# --- State Machines ---
states:
  plan: [proposed, approved]
  contract: [proposed, agreed, implemented, verified, integrated]
  task: [pending, in_progress, review, completed, blocked, failed]
  theta: [understand, generate, allocate, execute, verify, integrate]

# --- Guardian (Human Final Authority) ---
guardian:
  enabled: true
  github_username: ""           # Set to your GitHub username
  escalation_label: "guardian-review"
  budget_emergency_threshold_pct: 150
  auto_approve:
    theta_phase_transitions: false
    budget_increase: false
    deploy_staging: true
    deploy_production: false

# --- Verification Auto-Loop (exec verify) ---
verification:
  max_iterations: 10            # Default max retry count
  max_iterations_performance: 5 # Performance optimization (expensive)
  max_iterations_security: 3    # Security fixes (critical)
  checks:
    - lint
    - typecheck
    - test
    - security
  escalate_on_max: true         # Escalate to guardian when max reached

# --- Log-Driven Development (LDD) ---
ldd:
  enabled: true
  log_dir: .ai/logs
  format: "YYYY-MM-DD.md"
  sections:
    - intent
    - plan
    - implementation
    - verification

# --- Defaults ---
defaults:
  max_team_size: 5
  task_lease_minutes: 120

# --- Paths ---
paths:
  tasks: .shiki/tasks
  contracts: .shiki/contracts
  plans: .shiki/plans
  reports: .shiki/reports
  schemas: .shiki/schemas
  dag: .shiki/dag
  state: .shiki/state
