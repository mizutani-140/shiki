# プロンプト集（コピペ用）

このファイルは「毎回同じ品質で回す」ためのテンプレです。
プロジェクトに合わせて少しずつ調整してください。

---

## G0: ゴール → Plan（最初の指示）
> 目的：いきなり編集せず、Plan（設計・分割・リスク）を作る

```
あなたはこのリポジトリのAI開発統括（Team Leader）です。
まずは**Planモード**で、コード変更を始めずに設計を行ってください。

入力（ゴール）:
- GOAL.md を読み、ユーザーの最終ゴールと受け入れ条件を抽出する
- 不明点やリスクを列挙する（質問が必要なら最小限にまとめる）

出力:
1. 設計方針（アーキテクチャ/境界/契約）
2. タスク分割（並列化できる粒度）
3. 必要な役割（Team編成案：最大5役割まで）
4. `.shiki/plans/PLAN.md` を作る提案（内容をここに表示）
5. 追加で必要な情報があれば質問（最大5つ）

制約:
- この段階ではファイルを書き換えない（読み取り中心）
- 仕様を勝手に膨らませない。受け入れ条件から逸脱しない
```

---

## T0: Team Builder（役割の決定とメンバー起動）
> 目的：Planを元に、Agent Teams の役割を作る

```
次に、Planに基づき Agent Teams を編成してください。
役割の候補は roles/roles.yaml を参照し、足りない役割があれば追加提案してください。

メンバーはまず Plan Mode で起動し、各自が「担当領域の調査→実行計画」を作成してLeaderに提出してください。

チーム編成の目標:
- 競合を避けるため、各メンバーに担当ディレクトリ（ファイルオーナーシップ）を割り当てる
- 依存関係があるタスクは明示する
- 各メンバーは5〜6個のタスクを扱える粒度を目安にする
```

---

## E0: Task/Contract 作成（ブリッジ層に落とす）
> 目的：.shiki/tasks と .shiki/contracts を作る

```
Planとチームの提案に基づき、以下の成果物を作成してください。

- `.shiki/tasks/` にタスクJSONを作る
  - assigned_to は claude-team / codex / human
  - status は pending / blocked を基本
  - acceptance に「テスト合格条件」を必ず入れる
- APIや型など境界がある場合 `.shiki/contracts/` に契約ファイルを作る
  - status は proposed から開始
- `.shiki/reports/` は空でよい（実装後に埋まる）

その後、タスク一覧をMarkdownで要約してください。
```

---

## C0: Codex に実装を委託（MCP）
> 目的：仕様が明確なタスクを Codex に投げる

```
次のタスクを Codex に委託してください：
- 対象タスクID: T-xxxx
- 参照すべき contract: <contract_id>（あれば）
- 編集してよいファイル: <paths>
- 受け入れ条件（acceptance）: <commands/checklist>

Codexには以下を守らせてください：
- 変更は最小限
- 受け入れ条件のコマンドを実行して合格するまで反復
- `.shiki/reports/T-xxxx.md` を標準フォーマットで出力
```

---

## R0: レビュー統合（Claude Team）
> 目的：Codexや他メンバーの成果を統合する

```
提出された変更をレビューしてください。
観点:
- Contract準拠（破っていないか）
- 例外系/エッジケース
- セキュリティ（入力検証/権限/秘密情報）
- パフォーマンス（明らかな劣化がないか）
- テスト（回帰/不足）

必要なら「修正タスク」を新規作成し、担当を割り当ててください。
```

---

## CI0: CI失敗の自動修復（Codex→PR→Claudeレビュー）
```
CIが失敗しました。ログを読み、失敗原因を特定してください。
最小の変更で修正し、テストが通ることを確認してください。
修正内容と根拠を `.shiki/reports/CI-FIX-<id>.md` に書いてください。
```

---

## CLIモード用プロンプト

CLIモード（Agent Teams ネイティブ）で使用するプロンプト集です。

### CLI-TEAM: チーム作成（Delegate Mode Leader）

> 目的：Delegate Mode の Leader としてチームを作成し、タスクを割り当てる

```
あなたはこのリポジトリの Team Leader（coordinator）です。
Delegate Mode で動作してください（Edit/Write 禁止、調整・承認に専念）。

以下の手順でチームを構築してください：

1. GOAL.md を読み、ゴールと受け入れ条件を理解する
2. roles/roles.yaml を参照し、必要なロールを選定する
3. TeamCreate でチームを作成する
4. 各メンバーを以下の authority_layer で起動する：
   - coordinator: 計画・調整（Delegate Mode）
   - executor: 実装・テスト（Plan Mode 開始）
   - monitor: 品質・安全監視（常時 Plan Mode）
5. .shiki/tasks/ にタスクJSONを作成するよう指示する
6. 各メンバーにファイル所有権スコープを割り当てる
7. θ₁ UNDERSTAND フェーズから開始し、exit_criteria を管理する

制約:
- Edit/Write を使用しない（Delegate Mode）
- バジェットを意識する（.shiki/config.yaml の budget 参照）
- θフェーズの進行を記録する
```

---

### CLI-APPROVE: メンバー Plan の承認

> 目的：メンバーの Plan Mode 提出をレビューし、承認または差し戻す

```
メンバーから Plan が提出されました。以下の観点でレビューしてください：

レビュー観点:
1. タスクの要件と受け入れ条件を正しく理解しているか
2. 実装アプローチが適切か（過不足なく、最小限の変更か）
3. ファイル所有権スコープが明確で、他メンバーと競合しないか
4. 依存関係が正しく識別されているか
5. 見積もりが妥当か（バジェット内か）
6. 受け入れ条件の検証計画が十分か

判断:
- 問題なし → ExitPlanMode で承認（Standard Mode に移行）
- 修正必要 → SendMessage で具体的な修正要求を返す
- 根本的な問題 → タスク自体の再定義を検討

承認時のメッセージ例:
"Plan を承認しました。Standard Mode に移行して実装を開始してください。
注意点: [あれば記載]"

差し戻し時のメッセージ例:
"Plan に以下の修正が必要です。修正後に再提出してください。
1. [具体的な修正要求]
2. [具体的な修正要求]"
```

---

### CLI-CLAIM: タスクの自己割当（Self-Claim）

> 目的：メンバーが未割当タスクを自己申告する

```
未割当のタスクを確認し、自分のスコープに合致するものがあれば自己割当を申請してください。

手順:
1. TaskList で未割当タスク（claimed_by: null）を確認する
2. 以下の条件を満たすタスクを選択する：
   - authority_layer が自分の層（executor）と一致
   - ファイル所有権スコープが自分の担当範囲と合致
   - 依存タスクが完了している（またはブロックされていない）
   - 自分の現在の負荷で対応可能

3. coordinator に SendMessage で申請する：
   "T-XXXX の自己割当を申請します。
    理由: [適格性の根拠]
    現在の負荷: [現在のタスク状況]
    見積もり: [推定所要トークン/時間]"

4. coordinator の承認を待つ
5. 承認後、Plan Mode で計画を提出する

注意:
- 他のメンバーとの競合を避けるため、必ず coordinator の承認を得る
- 自分の authority_layer を超えたタスクは申請しない
- バジェット状況を考慮し、過度な引き受けを避ける
```

---

### CLI-RECOVER: セッション復旧

> 目的：中断したセッションから作業を再開する

```
前回のセッションから再開してください。以下の手順で復旧を行ってください。

復旧手順:
1. .shiki/state/ の最新のセッション状態ファイルを読み込む
2. .shiki/tasks/ の全タスクファイルを確認し、未完了タスクを特定する
3. 以下の情報を報告する：
   - 前回のθフェーズ
   - 未完了タスク一覧（status, assigned_to, priority）
   - ブロック中タスクとその理由
   - バジェット残量
4. チームを再構築する（TeamCreate）
   - 前回のメンバー構成を参考に再作成
   - 各メンバーに適切な authority_layer を割り当て
5. 未完了タスクを再割当する
   - in_progress だったタスクは前回の担当者に優先的に割り当て
   - pending タスクは通常の割当プロセスで対応
6. θフェーズの exit_criteria を確認し、作業を継続する

参考ファイル:
- .shiki/state/session-*.json（セッション状態）
- .shiki/tasks/*.json（タスク状態）
- .shiki/plans/PLAN.md（設計計画）
- .shiki/contracts/*.json（契約）
- .shiki/reports/*.md（完了レポート）

注意:
- 前回の会話履歴は失われています。ファイルから文脈を再構築してください
- バジェット残量に注意してください
```

